# Ch13 Fetch API

- ~~API와 CRUD 연산하기~~
- `fetch` 함수를 통해 API로부터 정보 얻기
  - Loading 화면
  - Error 화면
- +) Codespace에서 포트 CORS 해결하는 법

## useEffect에서 async 사용하려면?

```js
useEffect(() => {
  const fetchItems = async () => {
    // ...
  } // 1. async 함수 선언 후

  fetchItems();
  // 2. 안에서 **비동기적으로** 호출
}, [])
```

### +) TIL: IIFE

https://developer.mozilla.org/en-US/docs/Glossary/IIFE

```js
(() => {
  console.log("This is IIFE")
})() // Immediately called
```

만일 `fetchItems` 함수가 반환값을 가진다면 이 IIFE 구문을 사용해야 했을 것.

```js
let x = undefined;
(async () => {
  x = await fetchItems()
})();
```

## !!! 문제: `302 Found` 에러

`CORS`라는 것과 관련된 문제인 듯 하다.

=> Codespace 문제!!!

https://stackoverflow.com/questions/63862116/can-i-run-a-web-server-in-a-github-codespace

https://docs.github.com/en/codespaces/developing-in-a-codespace/forwarding-ports-in-your-codespace#sharing-a-port

`Private` => `Public`!

## Fetch error 대응

```js
try {
  const response = await fetch(API_URL);
  if (!response.ok) // !!!
    throw Error("Response Not OK");
  const listItems = await response.json();
  console.log(listItems);
  setItems(listItems);
} catch (err) {
  console.error(err.stack);
}
```

- `response.ok`가 아니라면: 오염된 정보 원천 차단(`throw`)

## 컴포넌트 조건적으로 표시

```jsx
{
  fetchError && (// only if fetchError is true (or not null)
    <p className='fetch-error'>
      Error: {fetchError}
    </p>
  )
}
{
  !fetchError && ( // only if fetchError is false (or null)
    <Content
      items={items.filter((x) => (
        x.item.toLowerCase().includes(search.toLowerCase()) // !!
      ))}
      handleCheck={handleCheck}
      handleDelete={handleDelete}
    />
  )
}
```

## Fetch Error 대응 2

```js
const [fetchError, setFetchError] = useState(null);

useEffect(() => {
  const fetchItems = async () => {
    try {
      const response = await fetch(API_URL);
      if (!response.ok) // !!!
        throw Error("Response Not OK");
      const listItems = await response.json();
      setItems(listItems);
    } catch (err) {
      setFetchError(err.message);
    }
  }

  (async () => await fetchItems())();
}, [])
```

그후 [컴포넌트 조건적으로 표시](#컴포넌트-조건적으로-표시) 사용해 에러 메세지 출력
